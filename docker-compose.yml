version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: doof-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: doof
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - doof-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/doof --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: doof-backend
    restart: unless-stopped
    ports:
      - "5000:5000"
    env_file:
      - .env
    environment:
      PORT: 5000
      NODE_ENV: development
      MONGODB_URI: mongodb://mongodb:27017/doof
      JWT_SECRET: doof_super_secret_jwt_key_change_in_production
      FRONTEND_URL: http://localhost:3000
      # Permitir acesso do emulador Android
      CORS_ORIGINS: http://localhost:3000,http://10.0.2.2:5000,exp://localhost:19000
      GOOGLE_CALLBACK_URL: http://localhost:5000/api/auth/google/callback
      FACEBOOK_CALLBACK_URL: http://localhost:5000/api/auth/facebook/callback
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - doof-network
    volumes:
      - ./backend:/app
      - /app/node_modules

  # Frontend React App
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: doof-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      VITE_API_URL: http://localhost:5000
    depends_on:
      - backend
    networks:
      - doof-network
    volumes:
      - ./frontend/src:/app/src
      - /app/node_modules
    stdin_open: true
    tty: true

  # Mobile React Native App
  mobile:
    build:
      context: ./mobile
      dockerfile: Dockerfile
    container_name: doof-mobile
    restart: unless-stopped
    ports:
      - "19000:19000"  # Expo Dev Server
      - "19001:19001"  # Expo Dev Tools
      - "19002:19002"  # Expo Metro Bundler
    environment:
      # Para Android Studio, o emulador precisa acessar o host, não o container
      # O backend está exposto na porta 5000 do host
      EXPO_PUBLIC_API_URL: http://host.docker.internal:5000/api
      NODE_ENV: development
    depends_on:
      - backend
    networks:
      - doof-network
    volumes:
      - ./mobile:/app
      - /app/node_modules
    stdin_open: true
    tty: true
    # Usar network_mode host no Linux para facilitar acesso do emulador
    # network_mode: host  # Descomente se estiver no Linux

  # Android Emulator com Expo
  android-emulator:
    image: budtmo/docker-android:emulator_11.0
    container_name: doof-android-emulator
    restart: unless-stopped
    privileged: true
    ports:
      - "6080:6080"    # VNC/NoVNC (acesso ao emulador via navegador)
      - "5554:5554"   # ADB
      - "5555:5555"   # ADB
      - "19003:19000" # Expo Dev Server (porta diferente para não conflitar)
      - "19004:19001" # Expo Dev Tools
      - "19005:19002" # Metro Bundler
    environment:
      EXPO_PUBLIC_API_URL: http://backend:5000/api
      NODE_ENV: development
      # Configurações do emulador (a imagem usa essas variáveis)
      # Deixar vazio para usar o AVD padrão da imagem
      EMULATOR_DEVICE: ""
      EMULATOR_OPTIONS: "-no-audio -no-window -gpu swiftshader_indirect"
    depends_on:
      - backend
    networks:
      - doof-network
    volumes:
      - ./mobile:/app
      - android-emulator-data:/root/.android
    stdin_open: true
    tty: true
    shm_size: 2gb

  # Android Emulator (Customizado)
  android_emulator:
    build: ./docker/android-emulator
    container_name: doof-android-emulator-custom
    restart: unless-stopped
    privileged: true
    ports:
      - "5555:5555"  # ADB
      - "8554:8554"  # Stream
    networks:
      - doof-network
    stdin_open: true
    tty: true
    shm_size: 2gb

networks:
  doof-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  android-emulator-data:
    driver: local

